pipeline {
        agent none 

        options {
            skipDefaultCheckout()
            buildDiscarder(logRotator(numToKeepStr: '10'))
        }
        
        stages {
            
            // =============================================================
            // 1. BUILD STAGE: Packages built and Stashed (Parallel on 2 Agents)
            // =============================================================
            stage('Build Packages') {
                parallel {
                    
                    // ðŸš€ Branch 1: Ubuntu (Build & Stash DEB)
                    stage('Ubuntu: Build DEB') {
                        agent { label 'ubuntu-agent' } 
                        steps {
                            script {
                                checkout scm
                                echo "--- Starting Ubuntu Agent (BUILD) ---"
                                
                                // CONSOLIDATED SHELL BLOCK 1: Setup and Build
                                sh '''
                                    echo "1. Setting up and Building .deb..."
                                    chmod +x nids-config.py
                                    
                                    # Prepare directory structure
                                    mkdir -p build-deb/usr/bin
                                    mkdir -p build-deb/etc/nids
                                    mkdir -p build-deb/DEBIAN
                                    
                                    # Copy files
                                    cp nids-config.py build-deb/usr/bin/nids-config
                                    chmod 755 build-deb/usr/bin/nids-config
                                    
                                    # Copy control files
                                    cp dockers/ubuntu-agent/control build-deb/DEBIAN/
                
                                    # Build the package
                                    sudo dpkg-deb --build build-deb
                                    mv build-deb.deb nids-config_1.0.0_all.deb
                                '''
                                
                                // Stash and Archive
                                stash name: 'deb_package', includes: 'nids-config_1.0.0_all.deb'
                                archiveArtifacts artifacts: 'nids-config_1.0.0_all.deb', fingerprint: true
                                
                                echo "--- Ubuntu Agent (BUILD) Finished ---"
                            }
                        }
                    }
                    
                    // ðŸš€ Branch 2: RHEL (Build & Stash RPM)
                    stage('RHEL: Build RPM') {
                        agent { label 'rhel-agent' } 
                        steps {
                            script {
                                checkout scm
                                echo "--- Starting RHEL Agent (BUILD) ---"
                                
                                // CONSOLIDATED SHELL BLOCK 2: Setup and Build
                                sh '''
                                    pwd
                                    echo "1. Setting up and Building .rpm..."
                                    chmod +x nids-config.py
                                    
                                    # Setup RPM structure
                                    rpmdev-setuptree
                                    
                                    # Create source directory and tarball
                                    mkdir -p ~/rpmbuild/BUILD/nids-config-1.0.0
                                    cp nids-config.py ~/rpmbuild/BUILD/nids-config-1.0.0/
                                    touch ~/rpmbuild/BUILD/nids-config-1.0.0/README.md
                                    
                                    # Copy spec file
                                    cp dockers/alma-agent/nids-config.spec ~/rpmbuild/SPECS/
                                    
                                    cd ~/rpmbuild/BUILD
                                    tar czf nids-config-1.0.0.tar.gz nids-config-1.0.0
                                    mv nids-config-1.0.0.tar.gz ~/rpmbuild/SOURCES/
                                    
                                    # Build the package
                                    rpmbuild -ba ~/rpmbuild/SPECS/nids-config.spec
                                    
                                    # Find the built RPM file and copy it to the current directory
                                    cd -
                                    find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} . \\;
                                '''
                                
                                // Stash and Archive
                                stash name: 'rpm_package', includes: '*.rpm'
                                archiveArtifacts artifacts: '*.rpm', fingerprint: true
                                
                                echo "--- RHEL Agent (BUILD) Finished ---"
                            }
                        }
                    }
                } // End of Build Stage Parallel
            } // End of Build Stage
            
            // =============================================================
            // 2. VALIDATION STAGE: Tests run against stashed packages (Parallel on 2 Agents)
            // =============================================================
            stage('Test Validation') {
                parallel {
                    
                    // ðŸ§ª Test 1: Validate DEB package on Ubuntu agent (IPv4 focused)
                    stage('Test: Ubuntu IPv4 Validation') {
                        agent { label 'ubuntu-agent' }
                        steps {
                            checkout scm
                            unstash 'deb_package' // Retrieve DEB built in previous stage
                            sh '''
                                echo "Installing DEB package..."
                                sudo dpkg -i nids-config_1.0.0_all.deb

                                # Ensure the installed command is on PATH
                                if ! command -v nids-config >/dev/null 2>&1; then
                                  if [ -x /usr/bin/nids-config ]; then
                                    sudo ln -sf /usr/bin/nids-config /usr/local/bin/nids-config
                                  fi
                                fi

                                echo "1) Enable IPv4 (bring interfaces up) and validate (config-only change)"
                                sudo nids-config --enable-ipv4
                                sudo python3 validator.py --expect-ipv4 true --expect-ipv6 skip

                                echo "2) Set promiscuous mode for IPv4 workflows and validate"
                                sudo nids-config --set-prom-ipv4
                                sudo python3 validator.py --expect-ipv4 true --expect-ipv6 skip

                                echo "3) Run configure-all (enable both protocols + promisc) and validate both"
                                sudo nids-config --configure-all
                                sudo python3 validator.py --run-configure-all --expect-ipv4 true --expect-ipv6 true

                                echo "Ubuntu IPv4 validation completed"
                            '''
                        }
                    }
                    
                    // ðŸ§ª Test 2: Validate RPM package on RHEL agent (IPv6 focused)
                    stage('Test: RHEL IPv6 Validation') {
                        agent { label 'rhel-agent' }
                        steps {
                            checkout scm
                            unstash 'rpm_package' // Retrieve RPM built in previous stage
                            sh '''
                                echo "Installing RPM package(s)..."
                                sudo dnf install -y *.rpm

                                # Ensure the installed command is on PATH
                                if ! command -v nids-config >/dev/null 2>&1; then
                                  if [ -x /usr/bin/nids-config ]; then
                                    sudo ln -sf /usr/bin/nids-config /usr/local/bin/nids-config
                                  fi
                                fi

                                echo "1) Disable IPv6 (kernel + config) and validate"
                                sudo nids-config --disable-ipv6
                                sudo python3 validator.py --expect-ipv6 false --expect-ipv4 skip

                                echo "2) Enable IPv6 (kernel + config) and validate"
                                sudo nids-config --enable-ipv6
                                sudo python3 validator.py --expect-ipv6 true --expect-ipv4 skip

                                echo "3) Set promiscuous mode for IPv6 workflows and validate"
                                sudo nids-config --set-prom-ipv6
                                sudo python3 validator.py --expect-ipv6 true --expect-ipv4 skip

                                echo "4) Run configure-all (enable both protocols + promisc) and validate both"
                                sudo nids-config --configure-all
                                sudo python3 validator.py --run-configure-all --expect-ipv4 true --expect-ipv6 true

                                echo "RHEL IPv6 validation completed"
                            '''
                        }
                    }
                } // End of Test Validation Parallel
            } // End of Test Validation Stage
        }
    }
pipeline {
    agent none 

    options {
        skipDefaultCheckout()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        
        // =============================================================
        // 1. BUILD STAGE: Packages built and Stashed (Parallel on 2 Agents)
        // =============================================================
        stage('Build Packages') {
            parallel {
                
                // ðŸš€ Branch 1: Ubuntu (Build & Stash DEB)
                stage('Ubuntu: Build DEB') {
                    agent { label 'ubuntu-agent' } 
                    steps {
                        script {
                            checkout scm
                            echo "--- Starting Ubuntu Agent (BUILD) ---"
                            
                            // CONSOLIDATED SHELL BLOCK 1: Setup and Build
                            sh '''
                                echo "1. Setting up and Building .deb..."
                                chmod +x nids-config.sh
                                sudo apt-get update
                                sudo apt-get install -y dpkg-dev fakeroot
                                
                                # Prepare and Copy files
                                mkdir -p build-deb/usr/sbin build-deb/DEBIAN
                                cp nids-config.sh build-deb/usr/sbin/nids-config
                                cp dockers/ubuntu-agent/control build-deb/DEBIAN/
                                
                                # Build the package
                                fakeroot dpkg-deb --build build-deb
                                mv build-deb.deb nids-config_1.0.0_all.deb
                            '''
                            
                            // Stash and Archive
                            stash name: 'deb_package', includes: 'nids-config_1.0.0_all.deb'
                            archiveArtifacts artifacts: 'nids-config_1.0.0_all.deb', fingerprint: true
                            
                            echo "--- Ubuntu Agent (BUILD) Finished ---"
                        }
                    }
                }
                
                // ðŸš€ Branch 2: RHEL (Build & Stash RPM)
                stage('RHEL: Build RPM') {
                    agent { label 'rhel-agent' } 
                    steps {
                        script {
                            checkout scm
                            echo "--- Starting RHEL Agent (BUILD) ---"
                            
                            // CONSOLIDATED SHELL BLOCK 2: Setup and Build
                            sh '''
                                echo "1. Setting up and Building .rpm..."
                                chmod +x nids-config.sh
                                sudo dnf install -y rpm-build
                                
                                # Setup RPM structure and Copy files
                                rpmdev-setuptree 
                                cp nids-config.sh ~/rpmbuild/SOURCES/
                                cp dockers/alma-agent/nids-config.spec ~/rpmbuild/SPECS/
                                
                                # Build the package
                                rpmbuild -ba ~/rpmbuild/SPECS/nids-config.spec
                                
                                # Find the built RPM file and copy it to the current directory
                                find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} . \\;
                            '''
                            
                            // Stash and Archive
                            stash name: 'rpm_package', includes: '*.rpm'
                            archiveArtifacts artifacts: '*.rpm', fingerprint: true
                            
                            echo "--- RHEL Agent (BUILD) Finished ---"
                        }
                    }
                }
            } // End of Build Stage Parallel
        } // End of Build Stage
        
        // =============================================================
        // 2. VALIDATION STAGE: Tests run against stashed packages (Parallel on 2 Agents)
        // =============================================================
        stage('Test Validation') {
            parallel {
                
                // ðŸ§ª Test 1: Validate DEB package on Ubuntu agent (Native Test)
                stage('Test: Ubuntu Native DEB') {
                    agent { label 'ubuntu-agent' }
                    steps {
                        unstash 'deb_package' // Retrieve DEB built in previous stage
                        sh '''
                            echo "Testing native DEB installation and script execution..."
                            
                            sudo dpkg -i nids-config_1.0.0_all.deb
                            
                            # Execute script and verify net.ipv4.ip_forward=1
                            sudo nids-config 1 1
                            
                            if [ $(sysctl -n net.ipv4.ip_forward) -eq 1 ]; then
                                echo "Validation SUCCESS: IPv4 Forwarding is 1."
                            else
                                echo "Validation FAILED: IPv4 Forwarding is not 1."
                                exit 1
                            fi
                        '''
                    }
                }
                
                // ðŸ§ª Test 2: Validate RPM package on RHEL agent (Native Test)
                stage('Test: RHEL Native RPM') {
                    agent { label 'rhel-agent' }
                    steps {
                        unstash 'rpm_package' // Retrieve RPM built in previous stage
                        sh '''
                            echo "Testing native RPM installation and script execution..."
                            
                            sudo dnf install -y *.rpm
                            
                            # Execute script and verify net.ipv6.conf.all.use_tempaddr=2
                            sudo nids-config 2 0
                            
                            if [ $(sysctl -n net.ipv6.conf.all.use_tempaddr) -eq 2 ]; then
                                echo "Validation SUCCESS: IPv6 Mode is 2."
                            else
                                echo "Validation FAILED: IPv6 Mode is not 2."
                                exit 1
                            fi
                        '''
                    }
                }
            } // End of Test Validation Parallel
        } // End of Test Validation Stage
    }
}